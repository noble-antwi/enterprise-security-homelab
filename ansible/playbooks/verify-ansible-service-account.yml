---
# ===================================================================
# ANSIBLE SERVICE ACCOUNT VERIFICATION PLAYBOOK
# ===================================================================
# 
# PURPOSE: Verify that the ansible service account is working correctly
# RUN AFTER: bootstrap-ansible-service-account.yml completes successfully
# ===================================================================

- name: Verify Ansible Service Account Configuration
  hosts: all_in_one
  become: true
  gather_facts: true
  
  tasks:
    
    # ===============================================================
    # BASIC CONNECTIVITY AND USER VERIFICATION
    # ===============================================================
    
    - name: Test ansible user exists and can connect
      ansible.builtin.shell: whoami
      register: current_user
      
    - name: Test ansible user can sudo without password
      ansible.builtin.shell: sudo whoami
      register: sudo_user
      
    - name: Test ansible user home directory exists
      ansible.builtin.stat:
        path: /home/ansible
      register: home_check
      
    # ===============================================================
    # SSH AND AUTOMATION VERIFICATION
    # ===============================================================
    
    - name: Test SSH key is properly installed
      ansible.builtin.stat:
        path: /home/ansible/.ssh/authorized_keys
      register: ssh_keys
      
    - name: Test sudoers file exists
      ansible.builtin.stat:
        path: /etc/sudoers.d/ansible
      register: sudoers_file
      
    # ===============================================================
    # AUTOMATION CAPABILITIES TEST
    # ===============================================================
    
    - name: Test package management capabilities
      ansible.builtin.package:
        name: curl
        state: present
      register: package_test
      
    - name: Test service status checking
      ansible.builtin.shell: systemctl is-active ssh || systemctl is-active sshd
      register: service_test
      failed_when: false
      
    - name: Test file operations
      ansible.builtin.copy:
        content: "Ansible automation test file"
        dest: /tmp/ansible-test-{{ ansible_date_time.epoch }}
        mode: '0644'
      register: file_test
      
    # ===============================================================
    # COMPREHENSIVE VERIFICATION REPORT
    # ===============================================================
    
    - name: Generate verification report
      ansible.builtin.debug:
        msg: |
          ========================================
          üîç ANSIBLE SERVICE ACCOUNT VERIFICATION
          ========================================
          
          üìã SYSTEM INFO:
          ‚Ä¢ Hostname: {{ ansible_hostname }}
          ‚Ä¢ IP: {{ ansible_default_ipv4.address }}
          ‚Ä¢ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          
          üë§ USER VERIFICATION:
          ‚Ä¢ Current User: {{ current_user.stdout }}
          ‚Ä¢ Sudo Access: {{ sudo_user.stdout }}
          ‚Ä¢ Home Directory: {{ 'EXISTS ‚úÖ' if home_check.stat.exists else 'MISSING ‚ùå' }}
          
          üîë SSH CONFIGURATION:
          ‚Ä¢ SSH Keys: {{ 'CONFIGURED ‚úÖ' if ssh_keys.stat.exists else 'MISSING ‚ùå' }}
          ‚Ä¢ Sudoers File: {{ 'EXISTS ‚úÖ' if sudoers_file.stat.exists else 'MISSING ‚ùå' }}
          
          üîß AUTOMATION CAPABILITIES:
          ‚Ä¢ Package Management: {{ 'WORKING ‚úÖ' if package_test is succeeded else 'FAILED ‚ùå' }}
          ‚Ä¢ Service Checking: {{ 'WORKING ‚úÖ' if service_test.rc == 0 else 'NEEDS CHECK ‚ö†Ô∏è' }}
          ‚Ä¢ File Operations: {{ 'WORKING ‚úÖ' if file_test is succeeded else 'FAILED ‚ùå' }}
          
          ========================================
          {{ 'üéâ ALL SYSTEMS OPERATIONAL - AUTOMATION READY!' if (current_user.stdout == 'ansible' and sudo_user.stdout == 'root' and ssh_keys.stat.exists) else '‚ö†Ô∏è SOME ISSUES DETECTED - CHECK ABOVE' }}
          ========================================

  # Clean up test files
  post_tasks:
    - name: Clean up test files
      ansible.builtin.file:
        path: /tmp/ansible-test-{{ ansible_date_time.epoch }}
        state: absent

# ===================================================================
# END OF VERIFICATION PLAYBOOK
# ===================================================================
